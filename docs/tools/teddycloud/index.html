<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="teddyCloud is an open source replacement server for the tonies cloud."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="teddyCloud"><meta property="og:description" content="teddyCloud is an open source replacement server for the tonies cloud."><meta property="og:type" content="website"><meta property="og:url" content="https://toniebox-reverse-engineering.github.io/docs/tools/teddycloud/"><title>teddyCloud | Toniebox Hacking</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.min.e2994ec3dc0cc7d1d85b138ad4e4c3f02d8abfa8b8471dfe0ab15a7a8a77d6ee.css integrity="sha256-4plOw9wMx9HYWxOK1OTD8C2Kv6i4Rx3+CrFaeop31u4=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.0f243b53f26a8514536c2777ef2c8c8228d6b21b034f2337da1947a4f3d34e2e.js integrity="sha256-DyQ7U/JqhRRTbCd37yyMgijWshsDTyM32hlHpPPTTi4=" crossorigin=anonymous></script>
<link rel=alternate type=application/rss+xml href=https://toniebox-reverse-engineering.github.io/docs/tools/teddycloud/index.xml title="Toniebox Hacking"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Toniebox Hacking</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul class=book-languages><li><input type=checkbox id=languages class=toggle>
<label for=languages class="flex justify-between"><a role=button class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
English</a></label><ul></ul></li></ul><ul><li><a href=/docs/how-to-get-started/>How to get started?</a><ul></ul></li><li><a href=/docs/tools/>Tools</a><ul><li><a href=/docs/tools/teddybench/>teddyBench</a><ul></ul></li><li><a href=/docs/tools/teddycloud/ class=active>teddyCloud</a><ul></ul></li></ul></li><li><a href=/docs/box-variants/>Box Variants</a><ul><li><a href=/docs/box-variants/cc3200/>CC3200</a></li><li><a href=/docs/box-variants/cc3235/>CC3235</a></li><li><a href=/docs/box-variants/esp32/>ESP32</a></li></ul></li><li><a href=/docs/custom-firmware/>Custom Firmware</a><ul><li><input type=checkbox id=section-42e43c8e420eed49ce3d0915aa7a0f11 class=toggle>
<label for=section-42e43c8e420eed49ce3d0915aa7a0f11 class="flex justify-between"><a href=/docs/custom-firmware/cc3200/>CC3200</a></label><ul><li><input type=checkbox id=section-fb4cb61a40d81e2312fca285b90fac32 class=toggle>
<label for=section-fb4cb61a40d81e2312fca285b90fac32 class="flex justify-between"><a href=/docs/custom-firmware/cc3200/hackieboxng-bl/>HackieboxNG Bootloader</a></label><ul><li><a href=/docs/custom-firmware/cc3200/hackieboxng-bl/install/>Installation</a></li><li><a href=/docs/custom-firmware/cc3200/hackieboxng-bl/bootloader/>Bootloader</a></li><li><a href=/docs/custom-firmware/cc3200/hackieboxng-bl/ofw-patches/>Firmware patches</a></li></ul></li><li><a href=/docs/custom-firmware/cc3200/hackiebox-cfw/>Hackiebox CFW PoC</a><ul></ul></li></ul></li></ul></li><li><a href=/docs/wiki/>Wiki</a><ul><li><input type=checkbox id=section-d8f00f9faa706cfd8232ca710ec83905 class=toggle>
<label for=section-d8f00f9faa706cfd8232ca710ec83905 class="flex justify-between"><a role=button>CC3200</a></label><ul><li><a href=/docs/wiki/cc3200/boot-process/>Boot Process</a></li><li><a href=/docs/wiki/cc3200/debug-port/>Debug port</a></li><li><a href=/docs/wiki/cc3200/firmware-layout/>Firmware layout</a></li><li><a href=/docs/wiki/cc3200/firmware-list/>Firmware list</a></li><li><a href=/docs/wiki/cc3200/hardware/>Hardware</a></li><li><a href=/docs/wiki/cc3200/microsd-compatibility/>microSD compatibility</a></li><li><a href=/docs/wiki/cc3200/pinout/>Pinout</a></li></ul></li><li><input type=checkbox id=section-67f43499674643a099dd84c6cb56579b class=toggle>
<label for=section-67f43499674643a099dd84c6cb56579b class="flex justify-between"><a role=button>ESP32</a></label><ul><li><a href=/docs/wiki/esp32/pinout/>Pinout</a></li></ul></li><li><input type=checkbox id=section-682231c8b0ba39c29d77ab65a2a7a682 class=toggle>
<label for=section-682231c8b0ba39c29d77ab65a2a7a682 class="flex justify-between"><a role=button>General</a></label><ul><li><a href=/docs/wiki/general/audio-file-format/>Audio file format</a></li><li><a href=/docs/wiki/general/battery-power-supply/>Battery & Power supply</a></li><li><a href=/docs/wiki/general/internal-audio-files/>Internal audio files</a></li><li><a href=/docs/wiki/general/known-problems/>Known problems</a></li><li><a href=/docs/wiki/general/protocol-analysis/>Protocol analysis</a></li><li><a href=/docs/wiki/general/traffic-sniffing/>Traffic sniffing</a></li><li><a href=/docs/wiki/general/useful-links/>Useful links</a></li></ul></li></ul></li></ul><ul><li><a href target=_blank rel=noopener>More</a><ul><li><a href=https://github.com/toniebox-reverse-engineering target=_blank rel=noopener>GitHub</a></li><li><a href=https://t.me/toniebox_reverse_engineering target=_blank rel=noopener>Telegram</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>teddyCloud</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#features>Features</a></li><li><a href=#preparation>Preparation</a><ul><li><a href=#generate-certificates>Generate certificates</a></li><li><a href=#dump-certificates-of-your-toniebox>Dump certificates of your toniebox</a></li><li><a href=#flash-the-replacement-ca>Flash the replacement CA</a></li><li><a href=#dns>DNS</a></li><li><a href=#content>Content</a></li><li><a href=#webinterface>Webinterface</a></li></ul></li><li><a href=#docker-hints>Docker hints</a></li></ul></nav></aside></header><article class=markdown><h1 id=teddycloud>teddyCloud
<a class=anchor href=#teddycloud>#</a></h1><h2 id=features>Features
<a class=anchor href=#features>#</a></h2><p>teddyCloud is an alternative server for your Toniebox, allowing you to host the cloud services locally.
This gives you the control about which data is sent to the original manufacturer&rsquo;s cloud and allows you
to host your own figurine audio files on e.g. your NAS or any other server.</p><h2 id=preparation>Preparation
<a class=anchor href=#preparation>#</a></h2><h3 id=generate-certificates>Generate certificates
<a class=anchor href=#generate-certificates>#</a></h3><p>First of all you&rsquo;ll need to generate the CA and certificates with the starting date 2015-11-03: This will be done automatically by teddyCloud if they are missing. Those will be placed in <code>/certs/server/</code>.
This also generates the replacement CA for the toniebox <code>certs/server/ca.der</code>.</p><h3 id=dump-certificates-of-your-toniebox>Dump certificates of your toniebox
<a class=anchor href=#dump-certificates-of-your-toniebox>#</a></h3><p>You&rsquo;ll need the <code>flash:/cert/ca.der</code> (Boxine CA), <code>flash:/cert/client.der</code> (Client Cert) and <code>flash:/cert/private.der</code> (Client private key). Place those files under <code>/certs/client/*</code>. You can either power the box with the battery (be sure it is note empty) or with the power supply. (recommended)
Depending on the Toniebox PCB you have (CC3200/CC3235/ESP32), there are different steps to do.</p><h4 id=cc3200>CC3200
<a class=anchor href=#cc3200>#</a></h4><p>You can use the <a href=https://github.com/toniebox-reverse-engineering/cc3200tool>cc3200tool</a> to dump your certificates over the Tag Connect debug port of the box. If you have installed the HackieboxNG Bootloader you should already have those files in your backup.</p><pre tabindex=0><code>cc3200tool -p COM3 read_file /cert/ca.der cert/ca.der read_file /cert/private.der cert/private.der read_file /cert/client.der cert/client.der
</code></pre><h4 id=cc3235>CC3235
<a class=anchor href=#cc3235>#</a></h4><p>You&rsquo;ll have to manually extract it from the flash of the box with a SOP8 clamp directly from the memory or by desoldering it. Reading in-circuit can be tricky, but is possible. I recommend flashrom as tool for that. It may be necessary to use a more recent version of it.
You can use the <a href=https://github.com/toniebox-reverse-engineering/cc3200tool>cc3200tool</a> to extract your certificates from the flash dump.</p><pre tabindex=0><code>cc3200tool -if cc32xx-flash.bin -d cc32xx read_all_files extract/
</code></pre><h4 id=esp32>ESP32
<a class=anchor href=#esp32>#</a></h4><p>You can extract the flash memory via the debug port of the box and the esptool. Keep your backup! Please use a recent version of esptool. (>v4.4)
Please connect the jumper J100 (Boot) and reset the box to put it into the required mode. Connect your 3.3V UART to J103 (TxD, RxD, GND).
If connected with the Boot jumper, the box just start in &ldquo;DOWNLOAD (USB/UART0)&rdquo; mode. (Check with a serial monitor). Beware, if the serial monitor is open it will block esptool.py from accessing the esp. If you get a &ldquo;BROWNOUT_RST&rdquo; check your power supply / battery. &ldquo;SPI_FAST_FLASH_BOOT&rdquo; indicates a boot without the J100 jumper.</p><h5 id=browser-based>Browser based
<a class=anchor href=#browser-based>#</a></h5><p>You can use the build in ESP32 box flashing tool in the webinterface of teddyCloud to backup your box with &ldquo;Read ESP32&rdquo;.
After that you can manually extract them into the <code>/certs/client/</code> directory.</p><pre tabindex=0><code># Please check the filename of your backup
teddycloud ESP32CERT extract data/firmware/ESP32_&lt;mac&gt;.bin certs/client
</code></pre><h5 id=legacy>Legacy
<a class=anchor href=#legacy>#</a></h5><pre tabindex=0><code># extract firmware
esptool.py -b 921600 read_flash 0x0 0x800000 tb.esp32.bin
# extract certficates from firmware
mkdir certs/client/esp32
teddycloud ESP32CERT extract tb.esp32.bin certs/client/esp32
# Copy box certificates to teddyCloud
cp certs/client/esp32/CLIENT.DER  certs/client/client.der
cp certs/client/esp32/PRIVATE.DER  certs/client/private.der
cp certs/client/esp32/CA.DER  certs/client/ca.der

# Copy certificates to temporary dir
mkdir certs/client/esp32-fakeca
cp certs/client/esp32/CLIENT.DER certs/client/esp32-fakeca/
cp certs/client/esp32/PRIVATE.DER certs/client/esp32-fakeca/
cp certs/server/ca.der certs/client/esp32-fakeca/CA.DER
</code></pre><h3 id=flash-the-replacement-ca>Flash the replacement CA
<a class=anchor href=#flash-the-replacement-ca>#</a></h3><h4 id=cc3200-1>CC3200
<a class=anchor href=#cc3200-1>#</a></h4><p>It is recommended to flash the replacement CA to /cert/c2.der and use the hackiebox-ng bootloader with the altCA patch. This will allow you to switch between the original and your replacement certificate. If you have installed the HackieboxNG Bootloader and the Hackiebox CFW you may upload the certificate via the webinterface of the CFW.</p><pre tabindex=0><code>cc3200tool -p COM3 write_file certs/server/ca.der /cert/c2.der
</code></pre><p><strong>Beware</strong> The <code>blockCheckRemove.310</code>, <code>noCerts.305</code> and the <code>noHide.308</code> patch breaks the content passthrough to Boxine. If you are using firmware 3.1.0_BF4 isn&rsquo;t compatible with many patches, except the alt* ones. Please disable them by removing them in the <a href=https://toniebox-reverse-engineering.github.io/docs/custom-firmware/cc3200/hackieboxng-bl/bootloader/#configuration><code>ngCfg.json</code></a> on the SD card.</p><h4 id=cc3235-1>CC3235
<a class=anchor href=#cc3235-1>#</a></h4><p>Replace the original CA within your flash dump with the replacement CA and reflash it to your box. I recommend flashrom for that</p><pre tabindex=0><code>cc3200tool -if cc32xx-flash.bin -of cc32xx-flash.customca.bin -d cc32xx customca.der /cert/ca.der
</code></pre><h4 id=esp32-1>ESP32
<a class=anchor href=#esp32-1>#</a></h4><h5 id=browser-based-1>Browser based
<a class=anchor href=#browser-based-1>#</a></h5><p>With teddyCloud you can also write a new image with your custom CA and a DNS/IP so the box connects to teddyCloud.
If you have a Fritzbox you can set it to tc.fritz.box (see CC3200 how to configure the hostname on your Fritzbox), if not set it to the IP of teddyCloud.</p><h5 id=legacy-1>Legacy
<a class=anchor href=#legacy-1>#</a></h5><p>Replace the original CA within your flash dump with esptool.</p><pre tabindex=0><code># copy firmware backup
cp tb.esp32.bin tb.esp32.fakeca.bin
# inject new CA into firmware
teddycloud ESP32CERT inject tb.esp32.fakeca.bin certs/client/esp32-fakeca
# flash firmware with new CA
esptool.py -b 921600 write_flash 0x0 tb.esp32.fakeca.bin
</code></pre><h3 id=dns>DNS
<a class=anchor href=#dns>#</a></h3><h4 id=cc3200-with-alturl-patch>CC3200 with altUrl patch
<a class=anchor href=#cc3200-with-alturl-patch>#</a></h4><p>With a CC3200 box it is recommened to use the altUrl patch. Set the DNS entries for <code>prod.revvox</code> and <code>rtnl.revvox</code> to the TeddyCloud servers ip-address.
If you have a fritzbox you can use the <a href=https://github.com/toniebox-reverse-engineering/hackiebox_cfw_ng/blob/master/sd-bootloader-ng/bootmanager/sd/revvox/boot/patch/altUrl.tc.fritz.box.json>altUrl tc.fritz.box</a> patch. You&rsquo;ll just have to set the name of your server in your fritzbox to <code>tc</code> (Heimnetz -> Netzwerk -> Netzwerkverbindungen -> bearbeiten
).
You may also edit the patch yourself to set the ip-address directly. Please beware, it should not be longer than the original url, which is 12 characters.</p><h4 id=cc3235-2>CC3235
<a class=anchor href=#cc3235-2>#</a></h4><p>Set the DNS entries for <code>prod.de.tbs.toys</code> and <code>rtnl.bxcl.de</code> to the TeddyCloud servers ip-address. Beware, this will cut off the connection of all tonieboxes within your network, which arn&rsquo;t patched with your replacement CA!
As an alternative you can set the gateway for the tonieboxes to the ip of teddyCloud. With OpenWRT it works this way:</p><pre tabindex=0><code>uci set dhcp.teddycloud=&#34;tag&#34;
uci set dhcp.teddycloud.dhcp_option=&#34;3,1.2.3.4&#34; # 1.2.3.4=teddycloud ip

uci add dhcp host
uci set dhcp.@host[-1].name=&#34;toniebox_1&#34;
uci set dhcp.@host[-1].mac=&#34;00:11:22:33:44:55&#34; # toniebox mac
uci set dhcp.@host[-1].ip=&#34;1.2.3.101&#34; # toniebox_1 ip
uci set dhcp.@host[-1].tag=&#34;teddycloud&#34;
uci commit dhcp
/etc/init.d/dnsmasq restart
</code></pre><h4 id=esp32-2>ESP32
<a class=anchor href=#esp32-2>#</a></h4><p>You can either set the IP/DNS within the image or you may do it like on the CC3235.</p><h3 id=content>Content
<a class=anchor href=#content>#</a></h3><p>Please put your content into the <code>/data/content/default/</code> in the same structure as on your toniebox. You can edit <code>500304E0.json</code> file beside the content files to mark them as live or you can prevent the usage of the Boxine cloud for that tag with the nocloud parameter. By setting a source teddyCloud can stream any content that ffmpeg can decode (urls and files).</p><h3 id=webinterface>Webinterface
<a class=anchor href=#webinterface>#</a></h3><p>Currently the interface to teddycloud is reachable through the IP of the docker container at port 80 or 443 (depending on your <code>docker-compose.yaml</code>). Changes affecting the toniebox (volume, LED) which are made through this interface will only be reflected onto the toniebox after pressing the big ear for a few seconds until a beep occurs.</p><p>As an additional frontend is still being developed, you can reach a second frontend at <code>xxx.xxx.xxx/web</code>. Changes made here are instantly live on the box.</p><h2 id=docker-hints>Docker hints
<a class=anchor href=#docker-hints>#</a></h2><p>The docker container automatically generates the server certificates on first run. You can extract the <code>certs/server/ca.der</code> for your box after that. The container won&rsquo;t run without the <code>flash:/cert/ca.der</code> (Boxine CA), <code>flash:/cert/client.der</code> (Client Cert) and <code>flash:/cert/private.der</code> (Client private key).</p><p>An example <a href=https://github.com/toniebox-reverse-engineering/teddycloud/blob/master/docker/docker-compose.yaml>docker-compose.yaml can be found within the docker subdir.</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/toniebox-reverse-engineering/toniebox-reverse-engineering.github.io/commit/70efbc2bcfab535aca4ad110e5b818fff6949dd4 title='Last modified by 0xbadbee | 2023-12-19' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>2023-12-19</span></a></div><div><a class="flex align-center" href=https://github.com/toniebox-reverse-engineering/toniebox-reverse-engineering.github.io/edit/master/content/docs/tools/teddyCloud/_index.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#features>Features</a></li><li><a href=#preparation>Preparation</a><ul><li><a href=#generate-certificates>Generate certificates</a></li><li><a href=#dump-certificates-of-your-toniebox>Dump certificates of your toniebox</a></li><li><a href=#flash-the-replacement-ca>Flash the replacement CA</a></li><li><a href=#dns>DNS</a></li><li><a href=#content>Content</a></li><li><a href=#webinterface>Webinterface</a></li></ul></li><li><a href=#docker-hints>Docker hints</a></li></ul></nav></div></aside></main></body></html>