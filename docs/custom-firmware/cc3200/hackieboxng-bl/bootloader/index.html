<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Start and read!"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Bootloader"><meta property="og:description" content="Start and read!"><meta property="og:type" content="article"><meta property="og:url" content="https://toniebox-reverse-engineering.github.io/docs/custom-firmware/cc3200/hackieboxng-bl/bootloader/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-01-01T10:42:06+01:00"><title>Bootloader | Toniebox Hacking</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.min.e2994ec3dc0cc7d1d85b138ad4e4c3f02d8abfa8b8471dfe0ab15a7a8a77d6ee.css integrity="sha256-4plOw9wMx9HYWxOK1OTD8C2Kv6i4Rx3+CrFaeop31u4=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.fdc973b75888751656560ca52c4ec476904598f3cae44f406f252b106e4c635b.js integrity="sha256-/clzt1iIdRZWVgylLE7EdpBFmPPK5E9AbyUrEG5MY1s=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Toniebox Hacking</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul class=book-languages><li><input type=checkbox id=languages class=toggle>
<label for=languages class="flex justify-between"><a role=button class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
English</a></label><ul></ul></li></ul><ul><li><a href=/docs/how-to-get-started/>How to get started?</a><ul></ul></li><li><a href=/docs/tools/>Tools</a><ul><li><a href=/docs/tools/teddybench/>teddyBench</a><ul></ul></li><li><a href=/docs/tools/teddycloud/>teddyCloud</a><ul></ul></li></ul></li><li><a href=/docs/box-variants/>Box Variants</a><ul><li><a href=/docs/box-variants/cc3200/>CC3200</a></li><li><a href=/docs/box-variants/cc3235/>CC3235</a></li><li><a href=/docs/box-variants/esp32/>ESP32</a></li></ul></li><li><a href=/docs/custom-firmware/>Custom Firmware</a><ul><li><input type=checkbox id=section-42e43c8e420eed49ce3d0915aa7a0f11 class=toggle checked>
<label for=section-42e43c8e420eed49ce3d0915aa7a0f11 class="flex justify-between"><a href=/docs/custom-firmware/cc3200/>CC3200</a></label><ul><li><input type=checkbox id=section-fb4cb61a40d81e2312fca285b90fac32 class=toggle checked>
<label for=section-fb4cb61a40d81e2312fca285b90fac32 class="flex justify-between"><a href=/docs/custom-firmware/cc3200/hackieboxng-bl/>HackieboxNG Bootloader</a></label><ul><li><a href=/docs/custom-firmware/cc3200/hackieboxng-bl/install/>Installation</a></li><li><a href=/docs/custom-firmware/cc3200/hackieboxng-bl/bootloader/ class=active>Bootloader</a></li><li><a href=/docs/custom-firmware/cc3200/hackieboxng-bl/ofw-patches/>Firmware patches</a></li></ul></li><li><a href=/docs/custom-firmware/cc3200/hackiebox-cfw/>Hackiebox CFW PoC</a><ul></ul></li></ul></li></ul></li><li><a href=/docs/wiki/>Wiki</a><ul><li><input type=checkbox id=section-d8f00f9faa706cfd8232ca710ec83905 class=toggle>
<label for=section-d8f00f9faa706cfd8232ca710ec83905 class="flex justify-between"><a role=button>CC3200</a></label><ul><li><a href=/docs/wiki/cc3200/boot-process/>Boot Process</a></li><li><a href=/docs/wiki/cc3200/debug-port/>Debug port</a></li><li><a href=/docs/wiki/cc3200/firmware-layout/>Firmware layout</a></li><li><a href=/docs/wiki/cc3200/firmware-list/>Firmware list</a></li><li><a href=/docs/wiki/cc3200/hardware/>Hardware</a></li><li><a href=/docs/wiki/cc3200/microsd-compatibility/>microSD compatibility</a></li><li><a href=/docs/wiki/cc3200/pinout/>Pinout</a></li></ul></li><li><input type=checkbox id=section-67f43499674643a099dd84c6cb56579b class=toggle>
<label for=section-67f43499674643a099dd84c6cb56579b class="flex justify-between"><a role=button>ESP32</a></label><ul><li><a href=/docs/wiki/esp32/pinout/>Pinout</a></li></ul></li><li><input type=checkbox id=section-682231c8b0ba39c29d77ab65a2a7a682 class=toggle>
<label for=section-682231c8b0ba39c29d77ab65a2a7a682 class="flex justify-between"><a role=button>General</a></label><ul><li><a href=/docs/wiki/general/audio-file-format/>Audio file format</a></li><li><a href=/docs/wiki/general/battery-power-supply/>Battery & Power supply</a></li><li><a href=/docs/wiki/general/internal-audio-files/>Internal audio files</a></li><li><a href=/docs/wiki/general/known-problems/>Known problems</a></li><li><a href=/docs/wiki/general/protocol-analysis/>Protocol analysis</a></li><li><a href=/docs/wiki/general/traffic-sniffing/>Traffic sniffing</a></li><li><a href=/docs/wiki/general/useful-links/>Useful links</a></li></ul></li></ul></li></ul><ul><li><a href target=_blank rel=noopener>More</a><ul><li><a href=https://github.com/toniebox-reverse-engineering target=_blank rel=noopener>GitHub</a></li><li><a href=https://t.me/toniebox_reverse_engineering target=_blank rel=noopener>Telegram</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Bootloader</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#preloader-stage-1>Preloader (Stage 1)</a></li><li><a href=#bootloader-stage-2>Bootloader (Stage 2)</a><ul><li><a href=#green-group---original-firmware>Green group - Original firmware</a></li><li><a href=#blue-group---custom-firmware>Blue group - Custom firmware</a></li><li><a href=#cyan-group---additonal-firmwares>Cyan group - Additonal firmwares</a></li><li><a href=#configuration>Configuration</a></li><li><a href=#sha256-check>SHA256 check</a></li><li><a href=#patches>Patches</a></li><li><a href=#error-codes>Error codes</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=hackieboxng-sd-bootloader>HackieboxNG SD bootloader
<a class=anchor href=#hackieboxng-sd-bootloader>#</a></h1><p>The HackieboxNG SD bootloader consists of two bootloaders (called stages). Both stages share the same codebase and are relocated to 0x20038000 before run.</p><h2 id=preloader-stage-1>Preloader (Stage 1)
<a class=anchor href=#preloader-stage-1>#</a></h2><p><img src=/img/HBNG-SDPreloader.png alt="Start process preloader"></p><p>The preloader runs a fixed file from the sd card (sd:/revvox/boot/ngbootloader.bin) without any checks. An update for shouldn&rsquo;t be necesarry in the future.
It should be installed as primary bootloader for HackieboxNG to flash:/sys/mcuimg.bin.</p><p><em><strong>All error codes for the preloader are in blue.</strong></em></p><h2 id=bootloader-stage-2>Bootloader (Stage 2)
<a class=anchor href=#bootloader-stage-2>#</a></h2><p><img src=/img/HBNG-SDBootloader.png alt="Start process bootloader"></p><p>When no ear is pressed, the bootloader loads the selected standard bootslot. If you hold the big ear while booting you may select a different slot by pressing the small ear for a short moment. Only slots with a file on the sd card can be selected. You may use them in a different way and change the settings within the configuration. The selected slot is indicated by 1-3 blinks in a color assigned to each group. Following slots are available:</p><p>Filepath: sd:/revvox/boot/ng-<em>XXXY</em>.bin</p><h3 id=green-group---original-firmware>Green group - Original firmware
<a class=anchor href=#green-group---original-firmware>#</a></h3><ol><li><strong>ofw1</strong> - OFW bootloader from flash:/sys/pre-img.bin recommended here</li><li><strong>ofw2</strong> - simulate OFW behaviour and load the same image like the OFW would, but with patches</li><li><strong>ofw3</strong> - specific OFW file with patches (optional)</li></ol><h3 id=blue-group---custom-firmware>Blue group - Custom firmware
<a class=anchor href=#blue-group---custom-firmware>#</a></h3><ol><li><strong>cfw1</strong> - Primary firmware (optional)</li><li><strong>cfw2</strong> - Backup firmware (optional)</li><li><strong>cfw3</strong> - (optional)</li></ol><h3 id=cyan-group---additonal-firmwares>Cyan group - Additonal firmwares
<a class=anchor href=#cyan-group---additonal-firmwares>#</a></h3><ol><li><strong>add1</strong> - (optional)</li><li><strong>add2</strong> - (optional)</li><li><strong>add3</strong> - (optional)</li></ol><p><em><strong>All error codes for the bootloader are in green.</strong></em></p><h3 id=configuration>Configuration
<a class=anchor href=#configuration>#</a></h3><p>The configuration for the bootloader is saved within <a href=https://github.com/toniebox-reverse-engineering/hackiebox_cfw_ng/blob/master/sd-bootloader-ng/bootmanager/sd/revvox/boot/ngCfg.json>sd:/revvox/boot/ngCfg.json</a>. All sections or keys starting with an underscore &ldquo;_&rdquo; are comments and will be ignored.</p><h4 id=general-section>General Section
<a class=anchor href=#general-section>#</a></h4><table><thead><tr><th>Key</th><th>Description</th><th>Values</th><th>Default</th></tr></thead><tbody><tr><td>activeImg</td><td>Sets the firmware slot to select at startup</td><td>ofw1, ofw2, ofw3, cfw1, cfw2, cfw3, add1, add2, add3</td><td>ofw1</td></tr><tr><td>waitForPress</td><td>Waits for an earpress on startup with a blink sequence (blue, green, cyan, black)</td><td>true, false</td><td>false</td></tr><tr><td>waitForBoot</td><td>Waits for an earpress on before firmware boot with a blink sequence (blue, green, cyan, black)</td><td>true, false</td><td>false</td></tr><tr><td>waitTimeoutInS</td><td>Timeout in seconds for waitForPress if no earpress (hibernation)</td><td>1-255</td><td>60</td></tr><tr><td>minBatteryLevel</td><td>Poweroff voltage to protect the battery. Divide through 2785 to get voltage (Standard 3.18V)</td><td></td><td>8869</td></tr><tr><td>ofwFixValue</td><td>Magic bytes to be placed into the OFW Image during boot (can be extracted from OFW BL data[-8:-4])</td><td>hex array with 4 bytes</td><td>[&ldquo;4C&rdquo;, &ldquo;01&rdquo;, &ldquo;10&rdquo;, &ldquo;00&rdquo;]</td></tr><tr><td>ofwFixFlash</td><td>Magic bytes read from the ofw bootloader on flash</td><td>ex. /sys/pre-img.bin</td><td></td></tr><tr><td>serialLog</td><td>Enable log to UART (TX) @921600 baud. Only works for debug build!</td><td>true, false</td><td>true</td></tr><tr><td>logLevel</td><td>Set Log level 0:Trace - 5:Fatal</td><td>0-5</td><td>DEBUG_LOG_LEVEL</td></tr><tr><td>logColor</td><td>Enable colored log</td><td>true, false</td><td>false</td></tr></tbody></table><h4 id=firmware-section>Firmware Section
<a class=anchor href=#firmware-section>#</a></h4><p>There are nine firmware slots, named ofw1, ofw2, ofw3, cfw1, cfw2, cfw3, add1, add2 and add3.</p><table><thead><tr><th>Key</th><th>Description</th><th>Values</th><th>Default</th></tr></thead><tbody><tr><td>checkHash</td><td>Check hash of firmware</td><td>true, false</td><td>true</td></tr><tr><td>hashFile</td><td>Chech hash from ng-XXX?.sha file (true) or from the last 64 byte of the firmware itself (ofw)</td><td>true, false</td><td>false</td></tr><tr><td>watchdog</td><td>Keep watchdog enabled when booting firmware (if booting fails, box will restart)</td><td>true, false</td><td>false</td></tr><tr><td>ofwFix</td><td>Add magic bytes to the firmware image to make ofw directly boot</td><td>true, false</td><td>false</td></tr><tr><td>ofwSimBL</td><td>Read image to boot from flash:/sys/mcubootinfo.bin and load the image from flash:/sys/mcuimgN.bin instead of reading from sd (like the ofw bootloader)</td><td>true, false</td><td>false</td></tr><tr><td>bootFlashImg</td><td>Read firmware from file on flash</td><td>true, false</td><td>false</td></tr><tr><td>flashImg</td><td>Path to the file on flash</td><td>ex. /sys/pre-img.bin</td><td></td></tr><tr><td>patches</td><td>List of patches to load, see <a href=https://github.com/toniebox-reverse-engineering/hackiebox_cfw_ng/tree/master/sd-bootloader-ng/bootmanager/sd/revvox/boot/patch>patch directory</a> or <a href=../ofw-patches>patch wiki</a></td><td>[&ldquo;noCerts.305&rdquo;, &ldquo;noPass3.305&rdquo;]</td><td>[]</td></tr></tbody></table><h3 id=sha256-check>SHA256 check
<a class=anchor href=#sha256-check>#</a></h3><p>For each slot an SHA256 check is available. Either as a seperated ng-<em>XXXY</em>.sha file or directly appended to the binary</p><p>For example all OFW binaries have a SHA256 appended to their file ending (except the ofw bootloader). A fitting ng-ofw1.sha is provided for the ofw bootloader.
The older Hackiebox CFW doesn&rsquo;t have a SHA256 appened. So you may need to create ng-<em>cfwX</em>.sha yourself if you want to use it. For HackieboxNG the SHA256 hash will be directly appended to the firmware file itself.</p><h4 id=windows>Windows
<a class=anchor href=#windows>#</a></h4><p>Command: <code>Get-Filehash FILENAME.BIN -Algorithm SHA256</code></p><h4 id=linux>Linux
<a class=anchor href=#linux>#</a></h4><p>Command: <code>shasum256 FILENAME.BIN</code></p><h3 id=patches>Patches
<a class=anchor href=#patches>#</a></h3><p>The integrated patch engine allows to apply patches to the loaded firmware in-memory. Currently just a simple dup2 patcher style <em>Search & Replace</em> engine ist implemented. You may patch up to 256 bytes per patch and apply up to 32 patches per slot. The patchname is limited to 32 characters.
<a href=../ofw-patches>More about available ofw patches</a></p><h3 id=error-codes>Error codes
<a class=anchor href=#error-codes>#</a></h3><p>If the bootloader detects a problem, it blinks in a defined pattern. The preloader on the flash blinks blue, the bootloader on the sd blinks green.</p><h4 id=sd-related-codes>SD related codes
<a class=anchor href=#sd-related-codes>#</a></h4><p>If a sd related problem occurs, the box combines two patterns. The first one indicates where the problem roughly occured. The second one gives you more information about it.</p><h5 id=first-pattern>First pattern
<a class=anchor href=#first-pattern>#</a></h5><h6 id=sd-not-found---2x500ms-wait-500ms>SD not found - 2x500ms, wait 500ms
<a class=anchor href=#sd-not-found---2x500ms-wait-500ms>#</a></h6><p>Please check if the sd is placed in the holder correctly and the sd is okay. The OFW will blink in red and shut off.</p><h6 id=file-could-not-be-opened---3x500ms-wait-2000ms>File could not be opened - 3x500ms, wait 2000ms
<a class=anchor href=#file-could-not-be-opened---3x500ms-wait-2000ms>#</a></h6><p>Problem opening the firmware file</p><h6 id=file-could-not-be-read---4x500ms-wait-2000ms>File could not be read - 4x500ms, wait 2000ms
<a class=anchor href=#file-could-not-be-read---4x500ms-wait-2000ms>#</a></h6><p>Problem reading the firmware file</p><h5 id=second-pattern-x-times-1000ms>Second pattern (X times 1000ms)
<a class=anchor href=#second-pattern-x-times-1000ms>#</a></h5><ol><li>FR_DISK_ERR, /* (1) A hard error occurred in the low level disk I/O layer */</li><li>FR_INT_ERR, /* (2) Assertion failed */</li><li>FR_NOT_READY, /* (3) The physical drive cannot work */</li><li>FR_NO_FILE, /* (4) Could not find the file */</li><li>FR_NO_PATH, /* (5) Could not find the path */</li><li>FR_INVALID_NAME, /* (6) The path name format is invalid */</li><li>FR_DENIED, /* (7) Access denied due to prohibited access or directory full */</li><li>FR_EXIST, /* (8) Access denied due to prohibited access */</li><li>FR_INVALID_OBJECT, /* (9) The file/directory object is invalid */</li><li>FR_WRITE_PROTECTED, /* (10) The physical drive is write protected */</li><li>FR_INVALID_DRIVE, /* (11) The logical drive number is invalid */</li><li>FR_NOT_ENABLED, /* (12) The volume has no work area */</li><li>FR_NO_FILESYSTEM, /* (13) There is no valid FAT volume */</li><li>FR_MKFS_ABORTED, /* (14) The f_mkfs() aborted due to any problem */</li><li>FR_TIMEOUT, /* (15) Could not get a grant to access the volume within defined period */</li><li>FR_LOCKED, /* (16) The operation is rejected according to the file sharing policy */</li><li>FR_NOT_ENOUGH_CORE, /* (17) LFN working buffer could not be allocated */</li><li>FR_TOO_MANY_OPEN_FILES, /* (18) Number of open files > _FS_LOCK */</li><li>FR_INVALID_PARAMETER /* (19) Given parameter is invalid */</li></ol><h4 id=other>Other
<a class=anchor href=#other>#</a></h4><h5 id=battery-low---2x66ms-2x133ms-2x66ms>Battery Low - 2x66ms, 2x133ms, 2x66ms
<a class=anchor href=#battery-low---2x66ms-2x133ms-2x66ms>#</a></h5><p>Battery is low. Value is under the minimum defined in minBatteryLevel. Box hibernates</p><h5 id=hash-differs---10x50ms>Hash differs - 10x50ms
<a class=anchor href=#hash-differs---10x50ms>#</a></h5><p>The actual hash of the firmware is different from the one defined in the firmware itself or in the hashfile (depens on the config). Checking the UART-output may help.</p><h5 id=watchdog-reset---5x33ms-5x66ms-5x33ms>Watchdog reset - 5x33ms, 5x66ms, 5x33ms
<a class=anchor href=#watchdog-reset---5x33ms-5x66ms-5x33ms>#</a></h5><p>The watchdog reseted the box, because the box was in an unintended state or the firmware is broken.</p><h5 id=application-error---3x33ms-3x66ms-3x33ms>Application error - 3x33ms, 3x66ms, 3x33ms
<a class=anchor href=#application-error---3x33ms-3x66ms-3x33ms>#</a></h5><p>Application error. This shouldn&rsquo;t happen.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/toniebox-reverse-engineering/toniebox-reverse-engineering.github.io/commit/b703843c50e4e03c3915b41df1f9e1d9c1b46039 title='Last modified by pepe | 2024-01-01' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>2024-01-01</span></a></div><div><a class="flex align-center" href=https://github.com/toniebox-reverse-engineering/toniebox-reverse-engineering.github.io/edit/master/content/docs/custom-firmware/cc3200/hackieboxng-bl/bootloader.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#preloader-stage-1>Preloader (Stage 1)</a></li><li><a href=#bootloader-stage-2>Bootloader (Stage 2)</a><ul><li><a href=#green-group---original-firmware>Green group - Original firmware</a></li><li><a href=#blue-group---custom-firmware>Blue group - Custom firmware</a></li><li><a href=#cyan-group---additonal-firmwares>Cyan group - Additonal firmwares</a></li><li><a href=#configuration>Configuration</a></li><li><a href=#sha256-check>SHA256 check</a></li><li><a href=#patches>Patches</a></li><li><a href=#error-codes>Error codes</a></li></ul></li></ul></nav></div></aside></main></body></html>